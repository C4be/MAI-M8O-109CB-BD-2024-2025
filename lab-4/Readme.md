# Лабораторная работа №4

Тема: Глава 5 из [книги](https://edu.postgrespro.ru/sql_primer.pdf). Упр 2, 9, 17, 18

Группа: М8О-109СВ-24

Выполнил: **Гимазетдинов Дмитрий Русланович**

---

## Упражнение 2
### Дано:

Посмотрите, какие ограничения уже наложены на атрибуты таблицы «Успеваемость» (`progress`). Воспользуйтесь командой `\d` утилиты `psql`. А теперь предложите для этой таблицы ограничение уровня таблицы.
В качестве примера рассмотрим такой вариант. Добавьте в таблицу `progress` еще один атрибут — «Форма проверки знаний» (`test_form`), который может принимать только два значения: «экзамен» или «зачет». Тогда набор допустимых значений атрибута «Оценка» (`mark`) будет зависеть от того, экзамен или зачет предусмотрены по данной дисциплине. Если предусмотрен экзамен, тогда допускаются значения 3, 4, 5, если зачет — тогда 0 (не зачтено) или 1 (зачтено).

Не забудьте, что значения `NULL` для атрибутов test_form и mark не допускаются.
Новое ограничение может быть таким:
```sql
ALTER TABLE progress
ADD CHECK (
( test_form = 'экзамен' AND mark IN ( 3, 4, 5 ) )
OR
( test_form = 'зачет' AND mark IN ( 0, 1 ) )
);
```
Проверьте, как будет работать новое ограничение в модифицированной таблице progress. Для этого выполните команды `INSERT`, как удовлетворяющие ограничению, так и нарушающие его. В таблице уже было ограничение на допустимые значения атрибута `mark`. Как вы думаете, не будет ли оно конфликтовать с новым ограничением? Проверьте эту гипотезу. Если ограничения конфликтуют, тогда удалите старое ограничение и снова попробуйте добавить строки в таблицу.

### Решение:

Рассмотрим какие ограничения уже на таблицу `progerss` у нас есть:

```sql
\d progress 
```

```bash
                             Таблица "public.progress"
   Столбец   |     Тип      | Правило сортировки | Допустимость NULL | По умолчанию 
-------------+--------------+--------------------+-------------------+--------------
 record_book | numeric(5,0) |                    | not null          | 
 subject     | text         |                    | not null          | 
 acad_year   | text         |                    | not null          | 
 term        | numeric(1,0) |                    | not null          | 
 mark        | numeric(1,0) |                    | not null          | 5
Ограничения-проверки:
    "progress_mark_check" CHECK (mark >= 3::numeric AND mark <= 5::numeric)
    "progress_term_check" CHECK (term = 1::numeric OR term = 2::numeric)
Ограничения внешнего ключа:
    "progress_record_book_fkey" FOREIGN KEY (record_book) REFERENCES students(record_book) ON UPDATE CASCADE ON DELETE CASCADE

```

##### Ограничения, которые уже существуют:
1. **CHECK (mark >= 3 AND mark <= 5)** — Оценка может быть только от 3 до 5.
2. **CHECK (term = 1 OR term = 2)** — Семестр может быть только 1 или 2.
3. **FOREIGN KEY (record_book)** — Внешний ключ связывает с таблицей *students*, обновляется и удаляется каскадно.

##### Возможные дополнительные ограничения:
1. **acad_year** — Ограничить формат учебного года, например, использовать регулярное выражение, чтобы формат был "YYYY-YYYY" (например, "2023-2024").
2. **subject** — Добавить ограничение по списку возможных предметов или длине строки (например, не более 100 символов).
3. **record_book** — Ограничить диапазон значений, например, чтобы было в диапазоне от 1 до 99999.
4. **Уникальность записи** — Добавить уникальный индекс для комбинации `record_book`, `subject`, `acad_year` и `term`, чтобы одна и та же запись не могла повториться для студента по предмету в конкретный год и семестр.


Проведем операции, которые нас просили по зазданию атрибута `test_from` и выведем структуру нашей таблицы:

```bash
edu=# \d progress 
                             Таблица "public.progress"
   Столбец   |     Тип      | Правило сортировки | Допустимость NULL | По умолчанию 
-------------+--------------+--------------------+-------------------+--------------
 record_book | numeric(5,0) |                    | not null          | 
 subject     | text         |                    | not null          | 
 acad_year   | text         |                    | not null          | 
 term        | numeric(1,0) |                    | not null          | 
 mark        | numeric(1,0) |                    | not null          | 5
 test_form   | text         |                    |                   | 
Ограничения-проверки:
    "progress_check" CHECK (test_form = 'экзамен'::text AND (mark = ANY (ARRAY[3::numeric, 4::numeric, 5::numeric])) OR test_form = 'зачет'::text AND (mark = ANY (ARRAY[0::numeric, 1::numeric])))
    "progress_mark_check" CHECK (mark >= 3::numeric AND mark <= 5::numeric)
    "progress_term_check" CHECK (term = 1::numeric OR term = 2::numeric)
Ограничения внешнего ключа:
    "progress_record_book_fkey" FOREIGN KEY (record_book) REFERENCES students(record_book) ON UPDATE CASCADE ON DELETE CASCADE

```


## Упражнение 9
### Дано:
### Решение:

---

## Упражнение 17
### Дано:
### Решение:

---

## Упражнение 18
### Дано:
### Решение:

---